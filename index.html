<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caro All-in-One - Huy Caro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --bg: #1a1a2e; --box: #16213e; --text: #fff; --grid: #30475e; --x: #e94560; --o: #4facfe; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 450px; padding: 15px; text-align: center; margin: auto; }

        h1 { color: var(--o); margin-bottom: 20px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(79, 172, 254, 0.5); }
        
        .screen { display: none; } 
        .screen.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        input, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px; border: none; outline: none; font-size: 16px; }
        input { background: var(--box); color: #fff; border: 2px solid var(--grid); text-align: center; font-weight: bold; }
        button { font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        button:active { transform: scale(0.98); box-shadow: none; }
        
        .btn-main { background: linear-gradient(45deg, #00f260, #0575e6); color: white; }
        .btn-sub { background: var(--grid); color: white; }
        .btn-ai { background: linear-gradient(45deg, #ff00cc, #333399); color: white; box-shadow: 0 0 15px rgba(255, 0, 204, 0.4); }
        .btn-offline { background: linear-gradient(45deg, #ff9966, #ff5e62); color: white; }
        .btn-restart { background: #f1c40f; color: #333; display: none; margin-top: 10px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        #board { 
            display: grid; grid-template-columns: repeat(15, 1fr); grid-template-rows: repeat(15, 1fr); 
            gap: 1px; background: var(--grid); border: 3px solid var(--grid); border-radius: 8px; 
            overflow: hidden; aspect-ratio: 1/1; margin: 0 auto; box-shadow: 0 10px 20px rgba(0,0,0,0.3); max-width: 100%;
        }

        .cell { 
            background: var(--bg); display: flex; align-items: center; justify-content: center; 
            font-size: clamp(10px, 3.5vw, 22px); font-weight: bold; cursor: pointer; width: 100%; height: 100%; line-height: 1; 
        }
        .cell:hover { background: #222240; }
        .cell.x { color: var(--x); text-shadow: 0 0 8px rgba(233, 69, 96, 0.6); } 
        .cell.o { color: var(--o); text-shadow: 0 0 8px rgba(79, 172, 254, 0.6); }
        
        .game-status-box { background: var(--box); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--grid); }
        
        footer { margin-top: 20px; padding: 20px 0; font-size: 0.9em; opacity: 0.9; border-top: 1px solid #333; width: 100%; text-align: center; background: #11111f; }
        .donate { color: #00f260; font-weight: bold; font-size: 1.3em; display: block; margin-top: 5px; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="screen-login" class="screen active">
            <h1>Caro Ultimate</h1>
            <p style="color:#aaa; margin-bottom: 20px;">Vua Tr√≤ Ch∆°i</p>
            <input type="text" id="username" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" maxlength="15">
            <button class="btn-main" onclick="goToMenu()">B·∫ÆT ƒê·∫¶U</button>
        </div>

        <div id="screen-menu" class="screen">
            <h2 id="welcome-msg" style="color: #fff;">Xin ch√†o!</h2>
            <br>
            <button class="btn-main" onclick="createRoom()">‚öîÔ∏è T·∫°o Ph√≤ng (Online)</button>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="room-input" placeholder="ID Ph√≤ng">
                <button class="btn-sub" onclick="joinRoom()" style="width: 80px;">V√†o</button>
            </div>
            <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">
            <button class="btn-offline" onclick="startOffline()">üë• Ch∆°i Offline (2 Ng∆∞·ªùi)</button>
            <button class="btn-ai" onclick="startAI()">ü§ñ ƒê·∫•u v·ªõi Boss (Random)</button>
        </div>

        <div id="screen-game" class="screen">
            <div class="game-status-box">
                <div id="room-id-display" style="color: #bbb; font-size: 0.9em; text-transform: uppercase;">---</div>
                <div id="status-display" style="font-size: 1.4em; font-weight: bold; margin: 8px 0; color: #fff;">---</div>
                <div style="font-size: 0.8em; color: #888;" id="sub-status"></div>
            </div>
            
            <div id="board"></div>
            <button id="btn-restart" class="btn-restart" onclick="restartCurrentMode()">üîÑ Ch∆°i v√°n m·ªõi</button>
            <button class="btn-sub" onclick="quitGame()" style="margin-top: 10px; background: #c0392b;">üè≥Ô∏è Tho√°t ra Menu</button>
        </div>
    </div>

    <footer>
        <div>‚òï Donate ·ªßng h·ªô Dev</div>
        <span class="donate">20088888866666</span>
        <div style="margin-top: 5px; color: #aaa;">MBBank - Dang Quang Huy</div>
    </footer>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDX5zqilc7zamn_XVFcIF_en-prH0VlV3k",
            authDomain: "huy-caro.firebaseapp.com",
            databaseURL: "https://huy-caro-default-rtdb.firebaseio.com",
            projectId: "huy-caro",
            storageBucket: "huy-caro.firebasestorage.app",
            messagingSenderId: "711387990292",
            appId: "1:711387990292:web:50d18472a522d7e0441a01",
            measurementId: "G-FN7N57N8R8"
        };
        
        if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); } }
        let db = null; try { db = firebase.database(); } catch(e) {}

        // BI·∫æN GAME
        let myName="", currentRoomId=null, mySymbol="", currentMode=""; // Mode: 'ONLINE', 'OFFLINE', 'AI'
        let boardState = Array(225).fill("");
        let isGameActive = true;
        let offlineTurn = 'X'; // D√πng ri√™ng cho ch·∫ø ƒë·ªô Offline
        const SIZE = 15;

        // UI FUNCTIONS
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function goToMenu() { myName = document.getElementById('username').value.trim() || "Ng∆∞·ªùi Ch∆°i"; document.getElementById('welcome-msg').innerText = "Xin ch√†o, " + myName; showScreen('screen-menu'); }
        
        function quitGame() { 
            if(currentRoomId && currentMode === 'ONLINE' && db) db.ref('rooms/'+currentRoomId).off(); 
            currentRoomId = null; 
            currentMode = ""; 
            showScreen('screen-menu'); 
        }

        // --- H√ÄM CH∆†I L·∫†I (T·∫§T C·∫¢ CH·∫æ ƒê·ªò) ---
        function restartCurrentMode() {
            if (currentMode === 'AI') startAI();
            else if (currentMode === 'OFFLINE') startOffline();
            else if (currentMode === 'ONLINE') restartOnline();
        }

        function initBoard() {
            const b = document.getElementById('board'); b.innerHTML = "";
            for(let i=0; i<225; i++) {
                let c = document.createElement('div'); c.className='cell';
                c.onclick = () => handleCellClick(i); b.appendChild(c);
            }
        }
        function updateBoardUI() {
            const cells = document.querySelectorAll('.cell');
            boardState.forEach((v, i) => {
                cells[i].className = 'cell ' + (v==='X'?'x':(v==='O'?'o':''));
                cells[i].innerText = v;
            });
        }

        // ==========================================
        // 1. CH·∫æ ƒê·ªò OFFLINE (2 NG∆Ø·ªúI)
        // ==========================================
        function startOffline() {
            currentMode = 'OFFLINE';
            isGameActive = true;
            boardState.fill("");
            offlineTurn = 'X'; // X lu√¥n ƒëi tr∆∞·ªõc
            document.getElementById('btn-restart').style.display='none';
            document.getElementById('room-id-display').innerText = "CH·∫æ ƒê·ªò OFFLINE";
            document.getElementById('status-display').innerText = "L∆∞·ª£t c·ªßa X";
            document.getElementById('status-display').style.color = "#e94560"; // M√†u c·ªßa X
            document.getElementById('sub-status').innerText = "2 ng∆∞·ªùi ch∆°i tr√™n c√πng m√°y";
            initBoard();
            showScreen('screen-game');
        }

        // ==========================================
        // 2. CH·∫æ ƒê·ªò AI BOSS (RANDOM TURN)
        // ==========================================
        function startAI() { 
            currentMode = 'AI';
            isGameActive = true; 
            boardState.fill(""); 
            document.getElementById('btn-restart').style.display='none'; 
            document.getElementById('room-id-display').innerText = "BOSS MODE";
            initBoard(); 
            showScreen('screen-game'); 

            // RANDOM: 50% B·∫°n l√† X, 50% B·∫°n l√† O
            if (Math.random() < 0.5) {
                mySymbol = 'X'; // B·∫°n ƒëi tr∆∞·ªõc
                document.getElementById('status-display').innerText = "L∆∞·ª£t c·ªßa b·∫°n (X)";
                document.getElementById('status-display').style.color = "#00f260";
            } else {
                mySymbol = 'O'; // Boss ƒëi tr∆∞·ªõc (Boss c·∫ßm X)
                document.getElementById('status-display').innerText = "Boss (X) ƒëi tr∆∞·ªõc...";
                document.getElementById('status-display').style.color = "#e94560";
                setTimeout(triggerBossTurn, 800); // Boss ƒë√°nh sau 0.8s
            }
            document.getElementById('sub-status').innerText = `B·∫°n c·∫ßm qu√¢n ${mySymbol}`;
        }

        // ==========================================
        // 3. CH·∫æ ƒê·ªò ONLINE (PVP)
        // ==========================================
        function createRoom() { if(!db) return alert("Firebase l·ªói!"); currentRoomId=Math.floor(10000+Math.random()*90000); mySymbol='X'; currentMode='ONLINE'; isGameActive=true; document.getElementById('btn-restart').style.display='none'; db.ref('rooms/'+currentRoomId).set({playerX:myName, playerO:"...", board:Array(225).fill(""), turn:'X'}); startGameOnline(); }
        function joinRoom() { if(!db) return alert("Firebase l·ªói!"); let id=document.getElementById('room-input').value; db.ref('rooms/'+id).once('value', s=>{ if(s.exists() && s.val().playerO==="...") { currentRoomId=id; mySymbol='O'; currentMode='ONLINE'; isGameActive=true; document.getElementById('btn-restart').style.display='none'; db.ref('rooms/'+id).update({playerO:myName}); startGameOnline(); } else alert("Ph√≤ng l·ªói!"); }); }
        
        function restartOnline() {
            // Trong online, n√∫t ch∆°i l·∫°i s·∫Ω x√≥a b√†n c·ªù
            if(db) db.ref('rooms/'+currentRoomId).update({board: Array(225).fill(""), turn: 'X', winner: null});
            document.getElementById('btn-restart').style.display='none';
        }

        function startGameOnline() { 
            initBoard(); showScreen('screen-game'); 
            document.getElementById('sub-status').innerText = mySymbol + " (Online)";
            if(db) { 
                document.getElementById('room-id-display').innerText="Ph√≤ng: "+currentRoomId; 
                db.ref('rooms/'+currentRoomId).on('value', s=>{ 
                    let d=s.val(); if(!d) return; 
                    boardState=d.board||Array(225).fill(""); updateBoardUI(); 
                    
                    // Logic th·∫Øng thua online
                    if(d.winner) { 
                        isGameActive = false;
                        let msg = d.winner===mySymbol ? "B·∫†N TH·∫ÆNG!" : "B·∫†N THUA!";
                        document.getElementById('status-display').innerText = msg;
                        document.getElementById('status-display').style.color = d.winner===mySymbol ? "#00f260" : "#e94560";
                        document.getElementById('btn-restart').style.display='block';
                    } 
                    else {
                        isGameActive = true;
                        document.getElementById('btn-restart').style.display='none';
                        if(d.turn===mySymbol) { document.getElementById('status-display').innerText="L∆∞·ª£t b·∫°n!"; document.getElementById('status-display').style.color="#00f260"; } 
                        else { document.getElementById('status-display').innerText="ƒê·ªëi th·ªß ƒëang ƒë√°nh..."; document.getElementById('status-display').style.color="#fff"; } 
                    }
                }); 
            } 
        }

        // ==========================================
        // X·ª¨ L√ù CLICK (CHUNG CHO M·ªåI CH·∫æ ƒê·ªò)
        // ==========================================
        function handleCellClick(i) {
            if(!isGameActive || boardState[i] !== "") return;

            // --- X·ª¨ L√ù OFFLINE ---
            if (currentMode === 'OFFLINE') {
                boardState[i] = offlineTurn;
                updateBoardUI();
                if(checkWin(boardState, offlineTurn)) {
                    endGame(offlineTurn);
                } else {
                    // ƒê·ªïi l∆∞·ª£t Offline
                    offlineTurn = offlineTurn === 'X' ? 'O' : 'X';
                    document.getElementById('status-display').innerText = "L∆∞·ª£t c·ªßa " + offlineTurn;
                    document.getElementById('status-display').style.color = offlineTurn === 'X' ? "#e94560" : "#4facfe";
                }
                return;
            }

            // --- X·ª¨ L√ù AI & ONLINE ---
            // Ch·ªâ ƒë√°nh ƒë∆∞·ª£c n·∫øu ƒë·∫øn l∆∞·ª£t m√¨nh
            let isMyTurn = false;
            if (currentMode === 'ONLINE') {
                // Check l∆∞·ª£t qua Firebase data (ƒë√£ x·ª≠ l√Ω trong startGameOnline)
                // Nh∆∞ng ta c·∫ßn check local ƒë·ªÉ ch·∫∑n click
                // (ƒê·ªÉ ƒë∆°n gi·∫£n, ta g·ª≠i request, n·∫øu server t·ª´ ch·ªëi th√¨ th√¥i)
            } 
            
            // Logic local AI
            if (currentMode === 'AI') {
                // N·∫øu m√¨nh l√† X th√¨ turn ph·∫£i l√† X (v√† ng∆∞·ª£c l·∫°i)
                // Nh∆∞ng ·ªü ƒë√¢y ta d√πng bi·∫øn mySymbol
                // N·∫øu boardState ƒë·∫øm s·ªë qu√¢n X v√† O b·∫±ng nhau -> L∆∞·ª£t X. L·ªách -> L∆∞·ª£t O
                let xCount = boardState.filter(k=>k==='X').length;
                let oCount = boardState.filter(k=>k==='O').length;
                let currentTurn = xCount === oCount ? 'X' : 'O';
                if (currentTurn !== mySymbol) return; // Ch∆∞a ƒë·∫øn l∆∞·ª£t
            }

            // Online Turn Check (S∆° b·ªô)
            if (currentMode === 'ONLINE') {
                 let xCount = boardState.filter(k=>k==='X').length;
                 let oCount = boardState.filter(k=>k==='O').length;
                 let currentTurn = xCount === oCount ? 'X' : 'O';
                 if (currentTurn !== mySymbol) return;
            }

            // Th·ª±c hi·ªán n∆∞·ªõc ƒëi
            boardState[i] = mySymbol; 
            updateBoardUI();

            if(checkWin(boardState, mySymbol)) { 
                endGame(mySymbol); 
                return; 
            }

            // AI RESPONSE
            if(currentMode === 'AI') {
                document.getElementById('status-display').innerText = "Boss ƒëang t√≠nh...";
                document.getElementById('status-display').style.color = "#fff";
                setTimeout(triggerBossTurn, 100); 
            }

            // ONLINE SYNC
            if(currentMode === 'ONLINE' && db) { 
                const next = mySymbol==='X'?'O':'X'; 
                db.ref('rooms/'+currentRoomId).update({ board: boardState, turn: next }); 
            }
        }

        function triggerBossTurn() {
            if(!isGameActive) return;
            const bossSymbol = mySymbol === 'X' ? 'O' : 'X'; // Boss c·∫ßm qu√¢n ng∆∞·ª£c l·∫°i
            const aiMove = getGodModeMove(bossSymbol); // AI c·∫ßm qu√¢n Boss
            
            if(aiMove !== -1) {
                boardState[aiMove] = bossSymbol; 
                updateBoardUI();
                if(checkWin(boardState, bossSymbol)) { endGame(bossSymbol); } 
                else {
                    document.getElementById('status-display').innerText = `L∆∞·ª£t c·ªßa b·∫°n (${mySymbol})`;
                    document.getElementById('status-display').style.color = "#00f260";
                }
            } else {
                alert("H√≤a c·ªù!"); endGame('DRAW');
            }
        }

        function endGame(winner) {
            isGameActive = false;
            let msg = "";
            let color = "#fff";

            if (currentMode === 'OFFLINE') {
                msg = winner + " ƒê√É TH·∫ÆNG!";
                color = winner === 'X' ? "#e94560" : "#4facfe";
            } 
            else if (currentMode === 'AI') {
                msg = winner === mySymbol ? "B·∫†N ƒê√É TH·∫ÆNG!" : "BOSS ƒê√É TH·∫ÆNG!";
                color = winner === mySymbol ? "#00f260" : "#e94560";
            }

            document.getElementById('status-display').innerText = msg;
            document.getElementById('status-display').style.color = color;
            document.getElementById('btn-restart').style.display = 'block';

            if(currentMode === 'ONLINE' && db) db.ref('rooms/'+currentRoomId).update({board:boardState, winner:winner});
        }

        // --- AI LOGIC (MINIMAX SIMPLIFIED) ---
        function getGodModeMove(bossSym) {
            const playerSym = bossSym === 'X' ? 'O' : 'X';
            if(boardState[112] === "") return 112; // ƒê√°nh gi·ªØa n·∫øu tr·ªëng

            let candidates = [];
            for(let i=0; i<225; i++) if(boardState[i] === "" && hasNeighbor(i)) candidates.push(i);

            let bestScore = -Infinity;
            let bestMove = candidates.length > 0 ? candidates[0] : -1;

            for(let move of candidates) {
                boardState[move] = bossSym;
                let score = evaluateBoard(bossSym);
                let enemyScore = evaluatePoint(move, playerSym);
                
                if(evaluatePoint(move, bossSym) >= 100000) { boardState[move] = ""; return move; } // Th·∫Øng lu√¥n
                if(enemyScore >= 10000) score += enemyScore * 20; // Ch·∫∑n thua (∆∞u ti√™n cao nh·∫•t)

                boardState[move] = "";
                if(score > bestScore) { bestScore = score; bestMove = move; }
            }
            return bestMove;
        }

        function hasNeighbor(idx) {
            const x = idx%SIZE, y = Math.floor(idx/SIZE);
            for(let dy=-1; dy<=1; dy++) for(let dx=-1; dx<=1; dx++) {
                if(dx===0 && dy===0) continue;
                let nx=x+dx, ny=y+dy;
                if(nx>=0 && nx<SIZE && ny>=0 && ny<SIZE && boardState[ny*SIZE+nx]!=="") return true;
            }
            return false;
        }
        function evaluateBoard(p) { let s=0; for(let i=0; i<225; i++) if(boardState[i]===p) s+=evaluatePoint(i, p); return s; }
        function evaluatePoint(idx, p) {
            const x=idx%SIZE, y=Math.floor(idx/SIZE); let total=0; const dirs=[[1,0],[0,1],[1,1],[1,-1]];
            for(let d of dirs) {
                let count=1, block=0;
                for(let k=1; k<5; k++) { let nx=x+d[0]*k, ny=y+d[1]*k; if(nx<0||nx>=SIZE||ny<0||ny>=SIZE){block++;break;} if(boardState[ny*SIZE+nx]===p)count++; else if(boardState[ny*SIZE+nx]!==""){block++;break;} else break; }
                for(let k=1; k<5; k++) { let nx=x-d[0]*k, ny=y-d[1]*k; if(nx<0||nx>=SIZE||ny<0||ny>=SIZE){block++;break;} if(boardState[ny*SIZE+nx]===p)count++; else if(boardState[ny*SIZE+nx]!==""){block++;break;} else break; }
                if(count>=5) total+=1000000; else if(count===4) total+=(block===0?100000:(block===1?5000:0)); else if(count===3) total+=(block===0?5000:(block===1?100:0)); else if(count===2) total+=(block===0?100:0);
            }
            return total;
        }
        function checkWin(b, p) {
            for(let i=0; i<SIZE; i++) for(let j=0; j<SIZE; j++) {
                let idx=i*SIZE+j; if(b[idx]!==p) continue;
                if(j+4<SIZE && b[idx+1]===p && b[idx+2]===p && b[idx+3]===p && b[idx+4]===p) return true;
                if(i+4<SIZE && b[idx+15]===p && b[idx+30]===p && b[idx+45]===p && b[idx+60]===p) return true;
                if(i+4<SIZE && j+4<SIZE && b[idx+16]===p && b[idx+32]===p && b[idx+48]===p && b[idx+64]===p) return true;
                if(i+4<SIZE && j-4>=0 && b[idx+14]===p && b[idx+28]===p && b[idx+42]===p && b[idx+56]===p) return true;
            }
            return false;
        }
    </script>
</body>
</html>
