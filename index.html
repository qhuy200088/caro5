<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caro Online Pro - Gemini Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg-color: #1a1a2e;
            --container-bg: #16213e;
            --accent-color: #e94560;
            --text-color: #ffffff;
            --grid-color: #30475e;
            --x-color: #e94560;
            --o-color: #4facfe;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 450px;
            padding: 15px;
            text-align: center;
            margin: auto;
        }

        h1 { margin-bottom: 15px; font-weight: 600; color: var(--o-color); }
        
        .screen { display: none; animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 15px;
            outline: none;
        }

        input {
            border: 2px solid var(--grid-color);
            background: var(--container-bg);
            color: white;
            text-align: center;
        }

        button {
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }
        
        button:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(45deg, #00f260, #0575e6); color: white; }
        .btn-secondary { background: var(--grid-color); color: white; }
        .btn-ai { background: linear-gradient(45deg, #ff9966, #ff5e62); color: white; }

        .game-info {
            background: var(--container-bg);
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* S·ª¨A L·ªñI √î B·ªä M√âO TH√ÄNH H√åNH CH·ªÆ NH·∫¨T */
        #board {
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            grid-template-rows: repeat(15, 1fr); /* √âp c·ªë ƒë·ªãnh 15 d√≤ng */
            gap: 1px;
            background-color: var(--grid-color);
            border: 2px solid var(--grid-color);
            border-radius: 5px;
            overflow: hidden;
            aspect-ratio: 1/1; /* B·∫Øt bu·ªôc khung ph·∫£i vu√¥ng */
            margin: 0 auto;
            max-width: 100%;
        }

        .cell {
            background-color: var(--bg-color);
            display: flex;
            align-items: center;
            justify-content: center;
            /* Ch·ªØ t·ª± co gi√£n theo m√†n h√¨nh */
            font-size: clamp(12px, 3.5vw, 22px); 
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        /* Hi·ªáu ·ª©ng di chu·ªôt */
        .cell:not(.x):not(.o):hover { background-color: #222240; }

        .cell.x { color: var(--x-color); text-shadow: 0 0 5px rgba(233, 69, 96, 0.5); }
        .cell.o { color: var(--o-color); text-shadow: 0 0 5px rgba(79, 172, 254, 0.5); }
        
        footer {
            margin-top: 20px;
            padding: 10px;
            text-align: center;
            font-size: 0.8em;
            opacity: 0.8;
            width: 100%;
            background: #11111f;
        }
        
        .donate-highlight {
            color: #00f260;
            font-weight: bold;
            display: block;
            margin-top: 5px;
            font-size: 1.2em;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="screen-login" class="screen active">
            <h1>Caro Online</h1>
            <input type="text" id="username" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n (VD: Huy Pro)" maxlength="15">
            <button class="btn-primary" onclick="goToMenu()">B·∫Øt ƒë·∫ßu</button>
        </div>

        <div id="screen-menu" class="screen">
            <h2 id="welcome-msg" style="margin-bottom: 20px;">Xin ch√†o!</h2>
            <button class="btn-primary" onclick="createRoom()">T·∫°o Ph√≤ng (2 Ng∆∞·ªùi)</button>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="room-input" placeholder="Nh·∫≠p ID 5 s·ªë" style="margin: 8px 0;">
                <button class="btn-secondary" onclick="joinRoom()" style="width: 80px;">V√†o</button>
            </div>
            <button class="btn-ai" onclick="startAI()">ƒê·∫•u v·ªõi Gemini AI (Si√™u Kh√≥)</button>
        </div>

        <div id="screen-game" class="screen">
            <div class="game-info">
                <div style="background: #e94560; display: inline-block; padding: 2px 10px; border-radius: 10px; font-size: 12px; margin-bottom: 5px;" id="room-id-display">Room: ---</div>
                <div id="status-display" style="font-weight: bold; font-size: 1.1em;">ƒêang ƒë·ª£i ƒë·ªëi th·ªß...</div>
                <div style="font-size: 12px; color: #888; margin-top: 5px;">
                    B·∫°n: <span id="my-symbol">---</span> | ƒê·ªëi th·ªß: <span id="opp-name">---</span>
                </div>
            </div>
            
            <div id="board"></div>
            
            <button class="btn-secondary" onclick="resetGame()" style="margin-top: 15px; background: #333;">Tho√°t tr·∫≠n</button>
        </div>
    </div>

    <footer>
        <div>‚òï Donate ·ªßng h·ªô Dev</div>
        <span class="donate-highlight">20088888866666</span>
        <div class="bank-info">MBBank - Dang Quang Huy</div>
    </footer>

    <script>
        // ==========================================
        // 1. C·∫§U H√åNH API KEY (ƒê√É ƒêI·ªÄN)
        // ==========================================
        
        // M√É API GEMINI C·ª¶A B·∫†N
        const GEMINI_API_KEY = "AIzaSyClCEHWwfnUlUVwCfgmCDEE0ryrRxb5Luk";

        // M√É FIREBASE (B·∫†N H√ÉY D√ÅN ƒêO·∫†N FIREBASE C·ª¶A B·∫†N V√ÄO D∆Ø·ªöI ƒê√ÇY)
        // -----------------------------------------------------------
        const firebaseConfig = {
            // !!! D√ÅN N·ªòI DUNG TRONG D·∫§U NGO·∫∂C { } C·ª¶A B·∫†N V√ÄO ƒê√ÇY !!!
            // V√≠ d·ª•:
            // apiKey: "AIzaSyDX5zqilc7zamn_XVFcIF_en-prH0VlV3k",
            // authDomain: "huy-caro.firebaseapp.com",
            // databaseURL: "https://huy-caro-default-rtdb.firebaseio.com",
            // projectId: "huy-caro",
            // storageBucket: "huy-caro.firebasestorage.app",
            // messagingSenderId: "711387990292",
            // appId: "1:711387990292:web:50d18472a522d7e0441a01",
            // measurementId: "G-FN7N57N8R8"
        };
        // -----------------------------------------------------------

        // Kh·ªüi t·∫°o Firebase
        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (e) {
                console.error("Ch∆∞a c·∫•u h√¨nh Firebase ƒë√∫ng c√°ch!");
            }
        }
        let db = null;
        try { db = firebase.database(); } catch(e) {}

        // Bi·∫øn to√†n c·ª•c
        let myName = "";
        let currentRoomId = null;
        let mySymbol = ""; 
        let isAiMode = false;
        let boardState = Array(225).fill(null); // M·∫£ng r·ªóng thay v√¨ ""
        for(let i=0; i<225; i++) boardState[i] = ""; // Reset v·ªÅ chu·ªói r·ªóng
        let isMyTurn = false;

        // --- ƒêI·ªÄU H∆Ø·ªöNG ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goToMenu() {
            const nameInput = document.getElementById('username').value.trim();
            if (!nameInput) return alert("Vui l√≤ng nh·∫≠p t√™n!");
            myName = nameInput;
            document.getElementById('welcome-msg').innerText = `Xin ch√†o, ${myName}!`;
            showScreen('screen-menu');
        }

        function resetGame() {
            if(currentRoomId && !isAiMode && db) db.ref('rooms/' + currentRoomId).off();
            currentRoomId = null;
            isAiMode = false;
            showScreen('screen-menu');
        }

        // --- GAME UI ---
        function initBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = "";
            for (let i = 0; i < 225; i++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.onclick = () => handleCellClick(i);
                boardEl.appendChild(cell);
            }
        }

        function updateBoardUI(boardData) {
            const cells = document.querySelectorAll('.cell');
            boardData.forEach((val, idx) => {
                cells[idx].className = 'cell'; 
                if (val === 'X') {
                    cells[idx].classList.add('x');
                    cells[idx].innerText = 'X';
                } else if (val === 'O') {
                    cells[idx].classList.add('o');
                    cells[idx].innerText = 'O';
                } else {
                    cells[idx].innerText = '';
                }
            });
        }

        // --- LOGIC X·ª¨ L√ù N∆Ø·ªöC ƒêI (QUAN TR·ªåNG) ---
        async function handleCellClick(index) {
            if (!isMyTurn || boardState[index] !== "") return;

            // 1. NG∆Ø·ªúI CH∆†I ƒê√ÅNH
            boardState[index] = mySymbol;
            updateBoardUI(boardState);
            
            // Check th·∫Øng ngay
            if (checkWinLocal(boardState, mySymbol)) {
                if(isAiMode) alert("B·∫†N ƒê√É TH·∫ÆNG GEMINI! üèÜ");
                else {
                    // C·∫≠p nh·∫≠t l√™n Firebase n·∫øu th·∫Øng online
                    db.ref('rooms/' + currentRoomId).update({ board: boardState, winner: mySymbol });
                }
                isMyTurn = false;
                return;
            }

            // 2. CH·∫æ ƒê·ªò AI (GEMINI PRO)
            if (isAiMode) {
                isMyTurn = false;
                document.getElementById('status-display').innerText = "Gemini ƒëang t√≠nh to√°n...";
                
                // G·ªçi AI
                const aiMove = await getGeminiMoveFromAPI();
                
                if (aiMove !== -1) {
                    boardState[aiMove] = 'O';
                    updateBoardUI(boardState);
                    
                    if (checkWinLocal(boardState, 'O')) {
                        document.getElementById('status-display').innerText = "Gemini th·∫Øng! ü§ñ";
                        setTimeout(() => alert("Gemini ƒë√£ th·∫Øng! B·∫°n c·∫ßn c·ªë g·∫Øng h∆°n."), 100);
                    } else {
                        isMyTurn = true;
                        document.getElementById('status-display').innerText = "ƒê·∫øn l∆∞·ª£t b·∫°n (X)";
                    }
                } else {
                    // AI l·ªói ho·∫∑c kh√¥ng t√¨m ra n∆∞·ªõc ƒëi
                    alert("AI b·ªã l·ªói k·∫øt n·ªëi, b·∫°n h√£y ƒë√°nh ti·∫øp!");
                    isMyTurn = true;
                }
                return;
            }

            // 3. CH·∫æ ƒê·ªò ONLINE
            if (db) {
                const nextTurn = mySymbol === 'X' ? 'O' : 'X';
                let winner = null;
                // Check h√≤a
                if (!boardState.includes("")) winner = "DRAW";

                db.ref('rooms/' + currentRoomId).update({
                    board: boardState,
                    turn: nextTurn,
                    winner: winner
                });
            }
        }

        // --- GEMINI AI PRO LOGIC ---
        async function getGeminiMoveFromAPI() {
            // Map b√†n c·ªù: 0=Tr·ªëng, 1=Ng∆∞·ªùi(X), 2=AI(O)
            const mapBoard = boardState.map(c => c === 'X' ? 1 : (c === 'O' ? 2 : 0));
            
            const prompt = `
                B·∫°n l√† ƒê·∫°i Ki·ªán T∆∞·ªõng Caro (Gomoku). B·∫°n c·∫ßm qu√¢n O (s·ªë 2). ƒê·ªëi th·ªß X (s·ªë 1).
                B√†n c·ªù 15x15 (m·∫£ng 225 ph·∫ßn t·ª≠): ${JSON.stringify(mapBoard)}
                
                CHI·∫æN THU·∫¨T:
                1. T·∫§N C√îNG: N·∫øu b·∫°n c√≥ 4 con th·∫Øng -> ƒê√°nh ngay.
                2. PH√íNG TH·ª¶ TUY·ªÜT ƒê·ªêI: N·∫øu ƒë·ªëi th·ªß (1) c√≥ 3 con h·ªü ho·∫∑c 4 con -> CH·∫∂N NGAY.
                3. PH√ÅT TRI·ªÇN: N·∫øu an to√†n, t·∫°o n∆∞·ªõc c·ªù ƒë√¥i ho·∫∑c n∆∞·ªõc 3 h·ªü.
                
                Y√™u c·∫ßu: Tr·∫£ v·ªÅ DUY NH·∫§T s·ªë Index (0-224) c·ªßa n∆∞·ªõc ƒëi. Kh√¥ng gi·∫£i th√≠ch.
            `;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent?key=${GEMINI_API_KEY}`;
            
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { temperature: 0.2 } // Gi·∫£m ƒë·ªô ng·∫´u nhi√™n ƒë·ªÉ ƒë√°nh ch·∫Øc tay
                    })
                });
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                const move = parseInt(text.match(/\d+/)[0]);
                return (boardState[move] === "") ? move : -1;
            } catch (e) {
                console.error("AI Error:", e);
                return -1; // Fallback
            }
        }

        // --- ONLINE LOGIC ---
        function createRoom() {
            if(!db) return alert("L·ªói k·∫øt n·ªëi Server Firebase!");
            currentRoomId = Math.floor(10000 + Math.random() * 90000).toString();
            mySymbol = 'X';
            
            db.ref('rooms/' + currentRoomId).set({
                id: currentRoomId,
                playerX: myName,
                playerO: "ƒêang ƒë·ª£i...",
                board: Array(225).fill(""),
                turn: 'X',
                winner: null
            });
            startGameOnline();
        }

        function joinRoom() {
            if(!db) return alert("L·ªói k·∫øt n·ªëi Server Firebase!");
            const inputId = document.getElementById('room-input').value.trim();
            if (inputId.length !== 5) return alert("ID ph√≤ng ph·∫£i c√≥ 5 s·ªë!");
            
            db.ref('rooms/' + inputId).once('value', snapshot => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (data.playerO !== "ƒêang ƒë·ª£i...") return alert("Ph√≤ng ƒë√£ ƒë·∫ßy!");
                    currentRoomId = inputId;
                    mySymbol = 'O';
                    db.ref('rooms/' + currentRoomId).update({ playerO: myName });
                    startGameOnline();
                } else {
                    alert("Ph√≤ng kh√¥ng t·ªìn t·∫°i!");
                }
            });
        }

        function startGameOnline() {
            initBoard();
            showScreen('screen-game');
            document.getElementById('room-id-display').innerText = "Ph√≤ng: " + currentRoomId;
            document.getElementById('my-symbol').innerText = mySymbol;

            db.ref('rooms/' + currentRoomId).on('value', snapshot => {
                const data = snapshot.val();
                if (!data) return;
                boardState = data.board || Array(225).fill("");
                updateBoardUI(boardState);

                const oppName = mySymbol === 'X' ? data.playerO : data.playerX;
                document.getElementById('opp-name').innerText = oppName;

                if (data.winner) {
                    document.getElementById('status-display').innerText = 
                        data.winner === 'DRAW' ? "H√≤a!" : (data.winner === mySymbol ? "B·∫†N TH·∫ÆNG! üéâ" : "B·∫†N THUA üò¢");
                    isMyTurn = false;
                    return;
                }

                if (data.turn === mySymbol) {
                    if(data.playerO === "ƒêang ƒë·ª£i...") {
                         document.getElementById('status-display').innerText = "ƒêang ƒë·ª£i ng∆∞·ªùi v√†o...";
                         isMyTurn = false;
                    } else {
                        isMyTurn = true;
                        document.getElementById('status-display').innerText = "ƒê·∫øn l∆∞·ª£t b·∫°n!";
                    }
                } else {
                    isMyTurn = false;
                    document.getElementById('status-display').innerText = "ƒê·ªëi th·ªß ƒëang ƒë√°nh...";
                }
            });
        }

        function startAI() {
            isAiMode = true;
            mySymbol = 'X';
            boardState = Array(225).fill("");
            initBoard();
            showScreen('screen-game');
            document.getElementById('room-id-display').innerText = "Ch·∫ø ƒë·ªô: ƒê·∫•u v·ªõi AI Pro";
            document.getElementById('opp-name').innerText = "Gemini 1.5 Pro";
            document.getElementById('my-symbol').innerText = "X";
            document.getElementById('status-display').innerText = "L∆∞·ª£t c·ªßa b·∫°n (X)";
            isMyTurn = true;
        }

        function checkWinLocal(board, player) {
            const size = 15;
            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const idx = i * size + j;
                    if (board[idx] !== player) continue;
                    // Ngang, D·ªçc, Ch√©o Huy·ªÅn, Ch√©o S·∫Øc
                    if (j+4<size && board[idx+1]===player && board[idx+2]===player && board[idx+3]===player && board[idx+4]===player) return true;
                    if (i+4<size && board[idx+size]===player && board[idx+2*size]===player && board[idx+3*size]===player && board[idx+4*size]===player) return true;
                    if (i+4<size && j+4<size && board[idx+size+1]===player && board[idx+2*size+2]===player && board[idx+3*size+3]===player && board[idx+4*size+4]===player) return true;
                    if (i+4<size && j-4>=0 && board[idx+size-1]===player && board[idx+2*size-2]===player && board[idx+3*size-3]===player && board[idx+4*size-4]===player) return true;
                }
            }
            return false;
        }
    </script>
</body>
</html>
