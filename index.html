<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caro Vua Tr√≤ Ch∆°i - Huy Caro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --bg: #1a1a2e; --box: #16213e; --text: #fff; --grid: #30475e; --x: #e94560; --o: #4facfe; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh;
            justify-content: center;
        }

        .container { width: 100%; max-width: 450px; padding: 15px; text-align: center; margin: auto; }

        h1 { color: var(--o); margin-bottom: 20px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(79, 172, 254, 0.5); }
        
        .screen { display: none; } 
        .screen.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        input, button { width: 100%; padding: 14px; margin: 8px 0; border-radius: 10px; border: none; outline: none; font-size: 16px; }
        input { background: var(--box); color: #fff; border: 2px solid var(--grid); text-align: center; font-weight: bold; }
        button { font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        button:active { transform: scale(0.98); box-shadow: none; }
        
        .btn-main { background: linear-gradient(45deg, #00f260, #0575e6); color: white; }
        .btn-sub { background: var(--grid); color: white; }
        .btn-ai { background: linear-gradient(45deg, #ff00cc, #333399); color: white; box-shadow: 0 0 15px rgba(255, 0, 204, 0.4); }
        .btn-restart { background: #f1c40f; color: #333; display: none; margin-top: 10px; }
        
        #board { 
            display: grid; 
            grid-template-columns: repeat(15, 1fr); 
            grid-template-rows: repeat(15, 1fr); 
            gap: 1px; 
            background: var(--grid); 
            border: 3px solid var(--grid); 
            border-radius: 8px; 
            overflow: hidden; 
            aspect-ratio: 1/1; 
            margin: 0 auto; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); 
            max-width: 100%;
        }

        .cell { 
            background: var(--bg); display: flex; align-items: center; justify-content: center; 
            font-size: clamp(10px, 3.5vw, 22px); font-weight: bold; cursor: pointer; width: 100%; height: 100%; line-height: 1; 
        }
        .cell:hover { background: #222240; }
        .cell.x { color: var(--x); text-shadow: 0 0 8px rgba(233, 69, 96, 0.6); } 
        .cell.o { color: var(--o); text-shadow: 0 0 8px rgba(79, 172, 254, 0.6); }
        
        .game-status-box { background: var(--box); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--grid); }
        
        footer { margin-top: 20px; padding: 20px 0; font-size: 0.9em; opacity: 0.9; border-top: 1px solid #333; width: 100%; text-align: center; background: #11111f; }
        .donate { color: #00f260; font-weight: bold; font-size: 1.3em; display: block; margin-top: 5px; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="screen-login" class="screen active">
            <h1>Caro Pro</h1>
            <p style="color:#aaa; margin-bottom: 20px;">Ch·∫ø ƒë·ªô Random Turn</p>
            <input type="text" id="username" placeholder="Nh·∫≠p t√™n ƒë·∫°i hi·ªáp" maxlength="15">
            <button class="btn-main" onclick="goToMenu()">B·∫ÆT ƒê·∫¶U</button>
        </div>

        <div id="screen-menu" class="screen">
            <h2 id="welcome-msg" style="color: #fff;">Xin ch√†o!</h2>
            <br>
            <button class="btn-main" onclick="createRoom()">‚öîÔ∏è T·∫°o Ph√≤ng (PVP)</button>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="room-input" placeholder="ID Ph√≤ng">
                <button class="btn-sub" onclick="joinRoom()" style="width: 80px;">V√†o</button>
            </div>
            <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">
            <button class="btn-ai" onclick="startAI()">üé≤ ƒê·∫•u v·ªõi Boss (Random)</button>
        </div>

        <div id="screen-game" class="screen">
            <div class="game-status-box">
                <div id="room-id-display" style="color: #bbb; font-size: 0.9em; text-transform: uppercase;">---</div>
                <div id="status-display" style="font-size: 1.4em; font-weight: bold; margin: 8px 0; color: #fff;">---</div>
                <div style="font-size: 0.8em; color: #888;">B·∫°n: <span id="my-symbol-display"></span></div>
            </div>
            
            <div id="board"></div>
            <button id="btn-restart" class="btn-restart" onclick="restartAiGame()">üîÑ Ch∆°i v√°n m·ªõi</button>
            <button class="btn-sub" onclick="resetGame()" style="margin-top: 10px; background: #c0392b;">üè≥Ô∏è ƒê·∫ßu h√†ng</button>
        </div>
    </div>

    <footer>
        <div>‚òï Donate ·ªßng h·ªô Dev</div>
        <span class="donate">20088888866666</span>
        <div style="margin-top: 5px; color: #aaa;">MBBank - Dang Quang Huy</div>
    </footer>

    <script>
        // FIREBASE CONFIG (C·ª¶A B·∫†N)
        const firebaseConfig = {
            apiKey: "AIzaSyDX5zqilc7zamn_XVFcIF_en-prH0VlV3k",
            authDomain: "huy-caro.firebaseapp.com",
            databaseURL: "https://huy-caro-default-rtdb.firebaseio.com",
            projectId: "huy-caro",
            storageBucket: "huy-caro.firebasestorage.app",
            messagingSenderId: "711387990292",
            appId: "1:711387990292:web:50d18472a522d7e0441a01",
            measurementId: "G-FN7N57N8R8"
        };
        
        if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error(e); } }
        let db = null; try { db = firebase.database(); } catch(e) {}

        // BI·∫æN GAME
        let myName="", currentRoomId=null, mySymbol="", isAiMode=false, isMyTurn=false;
        let boardState = Array(225).fill("");
        let isGameActive = true;
        const SIZE = 15;

        // UI FUNCTIONS
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function goToMenu() { myName = document.getElementById('username').value.trim() || "Ng∆∞·ªùi Ch∆°i"; document.getElementById('welcome-msg').innerText = "Xin ch√†o, " + myName; showScreen('screen-menu'); }
        function resetGame() { if(currentRoomId && !isAiMode && db) db.ref('rooms/'+currentRoomId).off(); currentRoomId = null; isAiMode = false; showScreen('screen-menu'); }
        
        // LOGIC KH·ªûI T·∫†O GAME V·ªöI AI (RANDOM)
        function startAI() { 
            isAiMode=true; 
            isGameActive=true; 
            boardState.fill(""); 
            document.getElementById('btn-restart').style.display='none'; 
            document.getElementById('room-id-display').innerText = "BOSS MODE";
            initBoard(); 
            showScreen('screen-game'); 

            // RANDOM QUY·ªÄN ƒêI TR∆Ø·ªöC (50/50)
            if (Math.random() < 0.5) {
                // B·∫°n ƒëi tr∆∞·ªõc
                mySymbol = 'X';
                isMyTurn = true;
                document.getElementById('status-display').innerText = "L∆∞·ª£t c·ªßa b·∫°n (X)";
            } else {
                // Boss ƒëi tr∆∞·ªõc
                mySymbol = 'O';
                isMyTurn = false;
                document.getElementById('status-display').innerText = "Boss ƒëang ƒëi tr∆∞·ªõc...";
                // Boss ƒë√°nh ngay
                setTimeout(triggerBossTurn, 800);
            }
            document.getElementById('my-symbol-display').innerText = mySymbol + " (ƒê·∫•u v·ªõi " + (mySymbol==='X'?'O':'X') + ")";
        }

        function restartAiGame() {
            // Khi ch∆°i l·∫°i c≈©ng Random l·∫°i t·ª´ ƒë·∫ßu
            startAI();
        }

        function initBoard() {
            const b = document.getElementById('board'); b.innerHTML = "";
            for(let i=0; i<225; i++) {
                let c = document.createElement('div'); c.className='cell';
                c.onclick = () => handleCellClick(i); b.appendChild(c);
            }
        }
        function updateBoardUI() {
            const cells = document.querySelectorAll('.cell');
            boardState.forEach((v, i) => {
                cells[i].className = 'cell ' + (v==='X'?'x':(v==='O'?'o':''));
                cells[i].innerText = v;
            });
        }

        // GAME LOGIC
        function handleCellClick(i) {
            if(!isGameActive || !isMyTurn || boardState[i] !== "") return;
            
            // Ng∆∞·ªùi ƒëi
            boardState[i] = mySymbol; updateBoardUI();
            if(checkWin(boardState, mySymbol)) { endGame(mySymbol); return; }

            // AI BOSS LOGIC
            if(isAiMode) {
                isMyTurn = false;
                document.getElementById('status-display').innerText = "Boss ƒëang t√≠nh...";
                setTimeout(triggerBossTurn, 100); 
                return;
            }

            // PVP ONLINE
            if(db) { const next = mySymbol==='X'?'O':'X'; db.ref('rooms/'+currentRoomId).update({ board: boardState, turn: next }); }
        }

        function triggerBossTurn() {
            if(!isGameActive) return;
            
            // X√°c ƒë·ªãnh qu√¢n c·ªßa Boss (Ng∆∞·ª£c l·∫°i v·ªõi ng∆∞·ªùi ch∆°i)
            const bossSymbol = mySymbol === 'X' ? 'O' : 'X';

            // G·ªåI THU·∫¨T TO√ÅN B·∫§T B·∫†I
            const aiMove = getGodModeMove(bossSymbol);
            
            if(aiMove !== -1) {
                boardState[aiMove] = bossSymbol; 
                updateBoardUI();
                if(checkWin(boardState, bossSymbol)) { endGame(bossSymbol); } 
                else {
                    isMyTurn = true;
                    document.getElementById('status-display').innerText = `L∆∞·ª£t c·ªßa b·∫°n (${mySymbol})`;
                }
            } else {
                alert("H√≤a c·ªù!"); isGameActive = false;
                document.getElementById('btn-restart').style.display = 'block';
            }
        }

        function endGame(winner) {
            isGameActive = false;
            let msg = winner === mySymbol ? "B·∫†N ƒê√É TH·∫ÆNG! (K·ª≥ t√≠ch)" : "BOSS ƒê√É TH·∫ÆNG! üíÄ";
            document.getElementById('status-display').innerText = msg;
            document.getElementById('status-display').style.color = winner === mySymbol ? "#00f260" : "#e94560";
            if(isAiMode) document.getElementById('btn-restart').style.display = 'block';
            if(!isAiMode && db) db.ref('rooms/'+currentRoomId).update({board:boardState, winner:winner});
        }

        // ==========================================
        // THU·∫¨T TO√ÅN GOD MODE (MINIMAX)
        // ==========================================
        
        function getGodModeMove(bossSymbol) {
            const playerSymbol = bossSymbol === 'X' ? 'O' : 'X';

            // 1. N∆∞·ªõc ƒë·∫ßu ti√™n lu√¥n ƒë√°nh gi·ªØa n·∫øu tr·ªëng (N·∫øu Boss ƒëi tr∆∞·ªõc ho·∫∑c ng∆∞·ªùi ch∆°i ƒë√°nh l·ªách)
            if(boardState[112] === "") return 112;

            // 2. L·ªçc c√°c √¥ ·ª©ng vi√™n
            let candidates = [];
            for(let i=0; i<225; i++) {
                if(boardState[i] === "" && hasNeighbor(i)) {
                    candidates.push(i);
                }
            }

            // 3. ƒê√°nh gi√°
            let bestScore = -Infinity;
            let bestMove = candidates[0];

            for(let move of candidates) {
                boardState[move] = bossSymbol; // Th·ª≠ ƒë√°nh
                
                // ƒêi·ªÉm l·ª£i th·∫ø c·ªßa m√¨nh
                let score = evaluateBoard(bossSymbol); 
                
                // ƒêi·ªÉm nguy hi·ªÉm c·ªßa ƒë·ªãch (N·∫øu m√¨nh kh√¥ng ƒë√°nh ƒë√¢y, ƒë·ªãch ƒë√°nh ƒë√¢y th√¨ sao?)
                let enemyScore = evaluatePoint(move, playerSymbol); 
                
                // N·∫øu n∆∞·ªõc n√†y th·∫Øng -> CH·ªêT
                if(evaluatePoint(move, bossSymbol) >= 100000) {
                    boardState[move] = ""; return move;
                }
                
                // N·∫øu ƒë·ªãch s·∫Øp th·∫Øng (4 con ho·∫∑c 3 h·ªü) -> PH·∫¢I CH·∫∂N (∆Øu ti√™n c·ª±c cao)
                if(enemyScore >= 10000) score += enemyScore * 15; 
                
                boardState[move] = ""; // Ho√†n tr·∫£

                if(score > bestScore) {
                    bestScore = score;
                    bestMove = move;
                }
            }
            return bestMove;
        }

        function hasNeighbor(idx) {
            const x = idx % SIZE, y = Math.floor(idx / SIZE);
            for(let dy=-1; dy<=1; dy++) {
                for(let dx=-1; dx<=1; dx++) {
                    if(dx===0 && dy===0) continue;
                    let nx=x+dx, ny=y+dy;
                    if(nx>=0 && nx<SIZE && ny>=0 && ny<SIZE) {
                        if(boardState[ny*SIZE + nx] !== "") return true;
                    }
                }
            }
            return false;
        }

        function evaluateBoard(player) {
            let score = 0;
            for(let i=0; i<225; i++) {
                if(boardState[i] === player) score += evaluatePoint(i, player);
            }
            return score;
        }

        function evaluatePoint(idx, p) {
            const x = idx % SIZE, y = Math.floor(idx / SIZE);
            let totalScore = 0;
            const dirs = [[1,0], [0,1], [1,1], [1,-1]];
            
            for(let d of dirs) {
                let count = 1, block = 0;
                // Xu√¥i
                for(let k=1; k<5; k++) {
                    let nx=x+d[0]*k, ny=y+d[1]*k;
                    if(nx<0||nx>=SIZE||ny<0||ny>=SIZE) { block++; break; }
                    let val = boardState[ny*SIZE+nx];
                    if(val === p) count++;
                    else if(val !== "") { block++; break; }
                    else break;
                }
                // Ng∆∞·ª£c
                for(let k=1; k<5; k++) {
                    let nx=x-d[0]*k, ny=y-d[1]*k;
                    if(nx<0||nx>=SIZE||ny<0||ny>=SIZE) { block++; break; }
                    let val = boardState[ny*SIZE+nx];
                    if(val === p) count++;
                    else if(val !== "") { block++; break; }
                    else break;
                }
                
                if(count >= 5) totalScore += 1000000;
                else if(count === 4) totalScore += (block===0 ? 100000 : (block===1 ? 5000 : 0));
                else if(count === 3) totalScore += (block===0 ? 5000 : (block===1 ? 100 : 0));
                else if(count === 2) totalScore += (block===0 ? 100 : 0);
            }
            return totalScore;
        }

        function checkWin(b, p) {
            for(let i=0; i<SIZE; i++) {
                for(let j=0; j<SIZE; j++) {
                    let idx = i*SIZE+j; if(b[idx]!==p) continue;
                    if(j+4<SIZE && b[idx+1]===p && b[idx+2]===p && b[idx+3]===p && b[idx+4]===p) return true;
                    if(i+4<SIZE && b[idx+15]===p && b[idx+30]===p && b[idx+45]===p && b[idx+60]===p) return true;
                    if(i+4<SIZE && j+4<SIZE && b[idx+16]===p && b[idx+32]===p && b[idx+48]===p && b[idx+64]===p) return true;
                    if(i+4<SIZE && j-4>=0 && b[idx+14]===p && b[idx+28]===p && b[idx+42]===p && b[idx+56]===p) return true;
                }
            }
            return false;
        }

        // ROOM LOGIC
        function createRoom() { if(!db) return alert("Firebase l·ªói!"); currentRoomId=Math.floor(10000+Math.random()*90000); mySymbol='X'; isAiMode=false; isGameActive=true; document.getElementById('btn-restart').style.display='none'; db.ref('rooms/'+currentRoomId).set({playerX:myName, playerO:"...", board:Array(225).fill(""), turn:'X'}); startGame(); }
        function joinRoom() { if(!db) return alert("Firebase l·ªói!"); let id=document.getElementById('room-input').value; db.ref('rooms/'+id).once('value', s=>{ if(s.exists() && s.val().playerO==="...") { currentRoomId=id; mySymbol='O'; isAiMode=false; isGameActive=true; document.getElementById('btn-restart').style.display='none'; db.ref('rooms/'+id).update({playerO:myName}); startGame(); } else alert("Ph√≤ng l·ªói!"); }); }
        
        function startGame() { 
            initBoard(); 
            showScreen('screen-game'); 
            isMyTurn=(mySymbol==='X'); 
            document.getElementById('status-display').innerText = isMyTurn?"L∆∞·ª£t b·∫°n ("+mySymbol+")":"ƒê·ª£i..."; 
            document.getElementById('my-symbol-display').innerText = mySymbol + " (Online)";

            if(!isAiMode && db) { 
                document.getElementById('room-id-display').innerText="Ph√≤ng: "+currentRoomId; 
                db.ref('rooms/'+currentRoomId).on('value', s=>{ 
                    let d=s.val(); if(!d) return; 
                    boardState=d.board||Array(225).fill(""); updateBoardUI(); 
                    if(d.winner) { endGame(d.winner); } 
                    else if(d.turn===mySymbol) { isMyTurn=true; document.getElementById('status-display').innerText="L∆∞·ª£t b·∫°n!"; } 
                    else { isMyTurn=false; document.getElementById('status-display').innerText="ƒê·ªëi th·ªß ƒëang ƒë√°nh..."; } 
                }); 
            } 
        }
    </script>
</body>
</html>
